name: Build OpenWrt for XG-040G-MD

on:
  workflow_dispatch:
    inputs:
      BRANCH:
        description: 'Kernel branch'
        default: 'current'
        required: true
        type: choice
        options:
          - 'current'
          - 'edge'
      RELEASE:
        description: 'Linux release'
        default: 'bookworm'
        required: true
        type: choice
        options:
          - 'bookworm'
          - 'trixie'
      BUILD_MINIMAL:
        description: 'Build minimal'
        default: 'yes'
        required: false
        type: choice
        options:
          - 'yes'
          - 'no'
      PREFER_DOCKER:
        description: 'Build with docker'
        default: 'no'
        required: false
        type: choice
        options:
          - 'yes'
          - 'no'
      DOCKER_ARMBIAN_BASE_IMAGE:
        description: 'Docker base image'
        default: 'ubuntu:noble'
        required: false
        type: choice
        options:
          - 'ubuntu:jammy'
          - 'ubuntu:noble'
      APPLY_PATCHES:
        description: 'Apply patches'
        default: 'yes'
        required: false
        type: choice
        options:
          - 'yes'
          - 'no'

env:
  TZ: Asia/Shanghai
  RELEASE: ${{ inputs.RELEASE }}
  BOARD: xg-040g-md

jobs:
  Build-OpenWrt-XG040G:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Initialization environment
        id: init
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          docker_images_ids=$(docker images -q)
          [ -n "${docker_images_ids}" ] && docker rmi ${docker_images_ids}
          docker system prune -a -f
          [[ -n "${AGENT_TOOLSDIRECTORY}" ]] && sudo rm -rf "${AGENT_TOOLSDIRECTORY}"
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android 2>/dev/null
          sudo swapoff -a
          sudo rm -f /swapfile /mnt/swapfile
          sudo -E apt-get -y purge azure-cli ghc* zulu* llvm* firefox google* dotnet* openjdk* mysql* php* mongodb* moby* snapd* android* || true
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo -E apt-get clean
          sudo sed -i '/NVM_DIR/d;/skel/d' /root/{.bashrc,.profile}
          sudo rm -rf ~/{.cargo,.dotnet,.rustup}
          sudo timedatectl set-timezone "${TZ}"

      - name: Create simulated physical disk
        id: disk
        run: |
          mnt_size=$(expr $(df -h /mnt | tail -1 | awk '{print $4}' | sed 's/[[:alpha:]]//g' | sed 's/\..*//') - 1)
          root_size=$(expr $(df -h / | tail -1 | awk '{print $4}' | sed 's/[[:alpha:]]//g' | sed 's/\..*//') - 4)
          sudo truncate -s "${mnt_size}"G /mnt/mnt.img
          sudo truncate -s "${root_size}"G /root.img
          LOOP_MNT=$(sudo losetup -f --show /mnt/mnt.img)
          LOOP_ROOT=$(sudo losetup -f --show /root.img)
          sudo pvcreate "${LOOP_MNT}"
          sudo pvcreate "${LOOP_ROOT}"
          sudo vgcreate -y github "${LOOP_MNT}" "${LOOP_ROOT}"
          sudo lvcreate -n runner -l 100%FREE github
          sudo mkfs.xfs /dev/github/runner
          sudo mkdir -p /mnt/workdir
          sudo mount /dev/github/runner /mnt/workdir
          sudo chown -R ${USER}:${USER} /mnt/workdir
          df -Th

      - name: Download source code
        working-directory: /mnt/workdir
        run: |
          df -hT ${PWD}
          git clone -q --single-branch --depth=1 --branch=main https://github.com/armbian/build.git build
          ln -sf /mnt/workdir/build ${GITHUB_WORKSPACE}/build

      - name: Apply patches
        if: ${{ inputs.APPLY_PATCHES == 'yes' }}
        working-directory: /mnt/workdir/build
        run: |
          "${GITHUB_WORKSPACE}/scripts/apply_patches.sh"
          "${GITHUB_WORKSPACE}/scripts/rename_to_conf.sh"

      - name: Compile OpenWrt for XG-040G-MD [ ${{ inputs.BRANCH }} ${{ inputs.RELEASE }} ]
        working-directory: /mnt/workdir/build
        run: |
          ./compile.sh build BOARD=xg-040g-md BRANCH=${{ inputs.BRANCH }} RELEASE=${{ inputs.RELEASE }} BUILD_MINIMAL=${{ inputs.BUILD_MINIMAL }} BUILD_DESKTOP=no \
            PREFER_DOCKER=${{ inputs.PREFER_DOCKER }} DOCKER_ARMBIAN_BASE_IMAGE=${{ inputs.DOCKER_ARMBIAN_BASE_IMAGE }} COMPRESS_OUTPUTIMAGE=xz KERNEL_CONFIGURE=no DEB_COMPRESS=xz

      - name: Prepare Image Metadata
        working-directory: /mnt/workdir/build/output/images
        run: |
          Image_File=$(find . -maxdepth 1 -type f -name 'Armbian*.img.xz' -printf '%f\n' | head -n 1)
          [ -z "${Image_File}" ] && { echo "No image files found."; tree; exit 1; }
          echo "Image_File: ${Image_File}"
          VERSION=$(echo "${Image_File}" | cut -d '_' -f 2 | cut -d '-' -f 1)
          echo "VERSION=${VERSION}" >> ${GITHUB_ENV}
          echo "VERSION: ${VERSION}"
          echo "CURRENT_YEAR_MONTH=$(date +'%Y.%m')" >> ${GITHUB_ENV}
          echo "CURRENT_YEAR_MONTH: $(date +'%Y.%m')"

      - name: Upload Image to Release
        uses: ncipollo/release-action@main
        with:
          tag: "OpenWrt-XG040G-${{ inputs.RELEASE }}-${{ env.CURRENT_YEAR_MONTH }}"
          name: "OpenWrt for XG-040G-MD (${{ inputs.RELEASE }}) - ${{ env.CURRENT_YEAR_MONTH }}"
          artifacts: "/mnt/workdir/build/output/images/*"
          allowUpdates: true
          removeArtifacts: false
          replacesArtifacts: true
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            ### OpenWrt Image for XG-040G-MD (Airoha EN7581)
            - Device: `XG-040G-MD`
            - Platform: `Airoha EN7581`
            - Release: `${{ inputs.RELEASE }}`
            - Kernel Branch: `${{ inputs.BRANCH }}`
            - Version: `${{ env.VERSION }}`
            - Username: `root`
            - Password: `1234`
            
            #### Device Specifications
            - CPU: Airoha EN7581 Dual Core ARM64
            - RAM: 1GB
            - Network: 2.5GbE Ethernet
            - Kernel: Based on unifreq/linux-6.12.y with full Airoha support
            
            #### Features
            - eBPF support for DAE proxy
            - OpenWrt optimized configuration
            - Full device tree support from upstream kernel
          draft: false
          prerelease: false

      - name: Delete releases and workflows runs
        uses: ophub/delete-releases-workflows@main
        with:
          delete_releases: false
          releases_keep_latest: 10
          delete_workflows: true
          workflows_keep_day: 3
          gh_token: ${{ secrets.GITHUB_TOKEN }}
